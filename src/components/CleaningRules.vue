<script setup lang="ts">
import { ref } from "vue";

import icons from "@/assets/icons";
import CleaningRule from "@/components/CleaningRule.vue";
import { use_cleaning_store } from "@/stores/cleaning";
import type { CleaningRuleProperties } from "@/types/cleaning";

const cleaning_store = use_cleaning_store();
const enableediting = ref(false);

const message_cleaning_rules = chrome.i18n.getMessage("cleaning_rules");
const message_clean_bookmarks = chrome.i18n.getMessage("clean_bookmarks");
const message_clean_history = chrome.i18n.getMessage("clean_history");
const message_save = chrome.i18n.getMessage("save");
const message_editing = chrome.i18n.getMessage("editing");

chrome.storage.sync
	.get<{
		cleaningrules: Record<string, CleaningRuleProperties>;
		cleaningruledefault: CleaningRuleProperties;
	}>({
		cleaningrules: {},
		cleaningruledefault: {
			subdomains: true,
			bookmarks: false,
			history: true,
		},
	})
	.then(
		({ cleaningrules, cleaningruledefault }) => {
			cleaning_store.rules = cleaningrules;
			cleaning_store.ruledefault = cleaningruledefault;
		},
		(reason) => {
			console.error(`chrome.storage.sync.get: ${reason}`);
		},
	);

async function clean_bookmarks() {
	cleaning_store.bookmarks = true;
	for (const hostname in cleaning_store.rules) {
		const properties = cleaning_store.rules[hostname];
		if (properties === undefined) {
			console.error(`Cleaning rule for ${hostname} is undefined.`);
			continue;
		}
		if (!properties.bookmarks) {
			continue;
		}
		for (const result of await chrome.bookmarks.search({
			query: hostname,
		})) {
			if (result.url === undefined) {
				continue;
			}
			const url = new URL(result.url);
			if (url.hostname === hostname || (properties.subdomains && url.hostname.endsWith(`.${hostname}`))) {
				console.info(`Deleting bookmark #${result.id}: ${result.url}...`);
				await chrome.bookmarks.remove(result.id);
			}
		}
	}
	cleaning_store.bookmarks = false;
}

async function clean_history() {
	cleaning_store.history = true;
	for (const hostname in cleaning_store.rules) {
		const properties = cleaning_store.rules[hostname];
		if (properties === undefined) {
			console.error(`Cleaning rule for ${hostname} is undefined.`);
			continue;
		}
		if (!properties.history) {
			continue;
		}
		for (const result of await chrome.history.search({
			text: hostname,
			maxResults: 1e9,
			startTime: 0,
		})) {
			if (result.url === undefined) {
				continue;
			}
			const url = new URL(result.url);
			if (url.hostname === hostname || (properties.subdomains && url.hostname.endsWith(`.${hostname}`))) {
				console.info(`Deleting history entry #${result.id}: ${result.url}...`);
				await chrome.history.deleteUrl({ url: result.url });
			}
		}
	}
	cleaning_store.history = false;
}

async function save_cleaning_rules() {
	await chrome.storage.sync
		.set({
			cleaningruledefault: cleaning_store.ruledefault,
			cleaningrules: cleaning_store.rules,
		})
		.catch((reason) => {
			console.error(`chrome.storage.sync.set: ${reason}`);
		});
	cleaning_store.updated = false;
	enableediting.value = false;
}
</script>

<template>
	<div class="card bg-base-200">
		<div class="card-body">
			<h2 class="card-title">
				<span class="text-center w-4">{{ icons.BROOM }}</span> {{ message_cleaning_rules }}
				<label class="label ml-auto">
					<input type="checkbox" class="toggle toggle-primary" v-model="enableediting" />
					{{ message_editing }}
				</label>
			</h2>
			<ul class="list">
				<CleaningRule :enableediting v-bind="cleaning_store.ruledefault" />
				<CleaningRule
					v-for="(properties, hostname, index) in cleaning_store.rules"
					:key="index"
					:enableediting
					:hostname
					v-bind="properties" />
			</ul>
			<div class="card-actions justify-end">
				<button type="button" class="btn btn-primary" :disabled="cleaning_store.bookmarks" @click="clean_bookmarks">
					{{ message_clean_bookmarks }}
				</button>
				<button type="button" class="btn btn-primary" :disabled="cleaning_store.history" @click="clean_history">
					{{ message_clean_history }}
				</button>
				<button
					type="button"
					class="btn btn-primary"
					:disabled="!enableediting || !cleaning_store.updated"
					@click="save_cleaning_rules">
					{{ message_save }}
				</button>
			</div>
		</div>
	</div>
</template>
